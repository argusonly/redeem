<!DOCTYPE html>
<html>
<head lang="en">
<meta charset="UTF-8">
<title>太古汇</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,height=device-height,inital-scale=1.0,maximum-scale=1.0,user-scalable=no;">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="format-detection" content="telephone=no">
<link media="all" type="text/css" rel="stylesheet" href="../assets/css/public-style.css">
<link media="all" type="text/css" rel="stylesheet" href="../assets/css/animate.min.css">
<link media="all" type="text/css" rel="stylesheet" href="../assets/css/side.css">
<link media="all" type="text/css" rel="stylesheet" href="../assets/css/tc.css">
<link media="all" type="text/css" rel="stylesheet" href="../assets/css/questionnaire.css">
</head>
<body>
<!-- 加载 -->
<div id="jiaZai">
  <img src="../assets/image/loadbg.png"></div>
<!-- 内容 -->
<!-- 内容 -->
<div id="main">
  <div class="title">
    <div>
      <img src="../assets/image/dhlp2.png">
      <img src="../assets/image/diaoCha.png">
      <span class="questionnaire-title">
          问卷调查
      </span>
      </div>
    <div>Survey</div></div>
  <div class="questionnaire" qindex="0">
  </div>
  <div class="anNiu">
    <a href="javascript:void (0)" class="sy last-option">上一页
      <br/>Previous</a>
    <a href="javascript:void (0)" class="xy next-option">下一页
      <br/>Next</a></div>
</div>
<div class="gn">
  <div class="dj">
    <div>
      <img src="../assets/image/gn1.png" class="xs" alt="">
      <img src="../assets/image/gn2.png" class="yc" alt=""></div>
    <div>
      <img src="../assets/image/gn2.png"></div>
  </div>
  <div class="nr">
    <div>礼品兑换系统</div>
    <p class="lp">
      <a href="../home/search.html">
        <img src="../assets/image/dhlp.png">礼品兑换</a></p>
    <p class="mm">
      <img src="../assets/image/bi.png" class="bi" alt="">修改密码</p>
    <p class="tuichu" onclick="window.TKH.logout();">
      <img src="../assets/image/dl2.png">退出登录</p>
    <div class="renWu">
      <img src="../assets/image/renWu.png">
      <p>18602897807</p>
      <p class="time"></p>
    </div>
  </div>
</div>
<div class="xg">
  <div>
    <a href="javascript:void (0)" class="gb">
      <img src="../assets/image/gb.png"></a>
    <div class="xg_content">
      <div class="suo">
        <img src="../assets/image/bi.png"></div>
      <div class="xg_info">
        <p class="title">修改密码</p>
        <input type="password" id="oldPassword" placeholder="旧密码" />
        <input type="password" id="newPassword" placeholder="新密码" />
        <input type="password" id="rePassword" placeholder="再次输入新密码" />
        <a href="javascript:void (0)" class="cs mima">确认修改密码</a></div>
    </div>
  </div>
</div>
</body>
<!-- Javascripts -->
<script src="../assets/js/remJs.js"></script>
<script src="../assets/js/jquery-1.8.0.min.js"></script>
<script src="../assets/js/plugins/layer/layer.js"></script>
<script src="../assets/js/tkh.js"></script>
<script src="../assets/js/side.js"></script>
<script>


var questionnaireString = window.localStorage.getItem("questionnaire");
if(questionnaireString === null) {
  window.TKH.queryCRMQuestionnaireMode();
}

var qindex = parseInt($(".questionnaire").attr("qindex"));
skipToQuestionWithIndex(qindex);

// {
//   "FRESULT": "0",
//   "FMSG": "成功",
//   "DATA": [
//     {
//       "FNUM": "02101703070001",
//       "FNAME": "开业活动调查",
//       "MODEDTL": [
//         {
//           "FTITLEID": "0",
//           "FTITLE": "你对今天的活动满意吗",
//           "FTYPE": "0",
//           "OPTIONDTL": [
//             {
//               "FVALUEID": "1",
//               "FVALUE": "满意"
//             },
//             {
//               "FVALUEID": "2",
//               "FVALUE": "不满意"
//             }
//           ]
//         }
//       ]
//   ]
// }
function skipToQuestionWithIndex(qindex) {
    var questionnaireString = window.localStorage.getItem("questionnaire");
    if(questionnaireString === null) { return }

    var questionnaireJSON = JSON.parse(questionnaireString);
        data_items = questionnaireJSON["DATA"],
        data_item = data_items[0],
        modeldtl_item = data_item["MODEDTL"][qindex],
        htmlString = '';

    storeQuestion();
    if(qindex === 0) {
        $(".last-option").html("上一页");
        $(".next-option").html("下一题");
    } else {
        $(".last-option").html("上一题");
        $(".next-option").html("下一题");

        if(qindex === data_item["MODEDTL"].length - 1) {
            $(".next-option").html("下一页");
        }
    }

    if(qindex >= data_item["MODEDTL"].length){
        window.TKH.saveCRMQuestionnaire();
        return;
    }

    $(".questionnaire-title").html(data_item["FNAME"]);
    htmlString += '<div class="wt">' + data_item["FTITLE"] +
      '<input type="hidden" name="fnum" id="fnum" value="' + data_item["FNUM"] + '" />\
       <input type="hidden" name="ftype" id="ftype" value="0" />\
       <input type="hidden" name="ftitleid" id="ftitleid" value="' + modeldtl_item["FTITLEID"] + '" />\
        <div class="kx">\
          <img src="../assets/image/diaoCha.png">可选答案\
          <span>' + modeldtl_item["OPTIONDTL"].length + '</span></div>\
        <div class="xz">';

    console.log(questionnaireString);
    for(var i = 0, len = modeldtl_item["OPTIONDTL"].length; i < len; i ++) {
        var option_item = modeldtl_item["OPTIONDTL"][i];
        console.log(option_item);
        htmlString += '<div  onclick="actionSelectQestion(this);" class="fvalueid" fvalueid="' + option_item["FVALUEID"] + '">' + option_item["FVALUE"] + '</div>';
    }
    htmlString += '</div></div>';

    $(".questionnaire").html(htmlString);
}

function storeQuestion() {
    var ftitleid = $("#ftitleid").val(),
      fvalues = [],
      fvalueids = [];

    if(ftitleid === undefined) return;

    $(".xz .xuanZhong").each(function() {
      fvalues.push($(this).html());
      fvalueids.push($(this).attr("fvalueid"));
    });

    var questionResult = window.localStorage.getItem("questionResult"),
        resultJSON = {};
    if(questionResult !== null) {
      resultJSON = JSON.parse(questionResult);
    }
    resultJSON[ftitleid] = { "ftitleid": ftitleid, fvalue: fvalues.join(','), fvalueid: fvalueids.join(',')}

    window.localStorage.setItem("questionResult", JSON.stringify(resultJSON));
}


// <div class="questionnaire">
//   <div class="wt">您如何到成都远洋太古汇? 需时多久?
//     <input type="hidden" name="ftitleid" id="ftitleid" value="0" />
//     <input type="hidden" name="ftype" id="ftype" value="1" /></div>
//   <div class="kx">
//     <img src="../assets/image/diaoCha.png">可选答案
//     <span>8</span></div>
//   <div class="xz">
//     <div id="1">自驾</div>
//     <div id="2">出租车</div>
//     <div id="3">公共汽车</div>
//     <div id="4">地铁</div>
//     <div id="5" class="xuanZhong">自行车</div>
//     <div id="6">步行</div>
//     <div id="7" class="xuanZhong">通常需要__分钟到达这里</div>
//     <div id="others">其他 Others(请注明)
//       <textarea class="ques_others"></textarea></div>
//   </div>
// </div>

//商品选中
function actionSelectQestion(ctl) {
    if ($('#ftype').val() == '0') {
        $('.xz .xuanZhong').removeClass('xuanZhong');
        $(ctl).addClass('xuanZhong');
    } else {
      // $('#others').removeClass('xuanZhong');
      if ($(ctl).hasClass('xuanZhong'))
        $(ctl).removeClass('xuanZhong');
      else
        $(ctl).addClass('xuanZhong');
    }
};
$(function() {
  $('.ques_others').focus(function() {
      $(this).parent().find('#others').addClass('xuanZhong');
  })

  $('.last-option').on('click', function() {
    var lastQIndex = parseInt($(".questionnaire").attr("qindex")) - 1;
    $(".questionnaire").attr("qindex", lastQIndex);
    if(lastQIndex >= 0) {
        skipToQuestionWithIndex(lastQIndex);
    } else {
        window.location.href = "../home/search.html"
    }
  });

  $('.next-option').on('click', function() {
    var nextQIndex = parseInt($(".questionnaire").attr("qindex")) + 1;
    $(".questionnaire").attr("qindex", nextQIndex);
    skipToQuestionWithIndex(nextQIndex);
  });
});


</script>
</html>
